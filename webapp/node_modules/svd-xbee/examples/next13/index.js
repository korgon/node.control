var util = require('util');
var config = require('./config.json');
var XBee = require('../../index.js');
var Flower = require('./Flower.js');
var io_server = require('socket.io');
var io_client = require('socket.io-client');

// XBee
var xbee = new XBee.XBee({
  port: config.xbee_port,
  baudrate: config.xbee_baud
}).init();

// Add Flower Node
var flower = new Flower(config.flower_addr, xbee);

// Sockets
var socket_server = io_server.listen(8008);
var socket_client = io_client.connect("http://"+config.remote, {
  port: 8008
});

var _socket;

socket_client.on('connect', function() {
  console.log('connected as client'); 
  socket_client.on("flower_near", FlowerNear);
  socket_client.on("flower_far", FlowerFar);
});

socket_server.on('connection', function(socket) {
  _socket = socket;
  console.log('client connected');
  socket.on('flower_near', FlowerNear);
  socket.on('flower_far', FlowerFar);
});

function RemoteFlowerFar(data) {
  console.log("Remote: far");
  if (flower.isNear) flower.openHalf();
  else flower.close();
}

function RemoteFlowerNear(data) {
  console.log("Remote: near");
  if (flower.isNear) flower.openFull();
  else flower.openHalf();
}

flower.on('near', function() {
  console.log("Local: near");
  socket_client.emit('flower_near', {});
  if (_socket)
    _socket.emit('flower_near', {});
});

flower.on('far', function() {
  console.log("Local: far");
  socket_client.emit('flower_far', {});
  if (_socket)
    _socket.emit('flower_far', {});
});

flower.on("discovered", function(node) {
  console.log("Flower Discovered");
});


// Emitted when .init() is done (COM port open, parameters read)
xbee.on("initialized", function(params) {
  xbee.discover(); 
  console.log("Node discovery starded...");
});

xbee.on("discoveryEnd", function() {
  console.log("...node discovery over");
});

// Triggered whenever a node is discovered that is not already
// added. / myNode will not show up here!
xbee.on("newNodeDiscovered", function(node) {
  console.log("Node %s discovered", util.inspect(node.remote64))
});
